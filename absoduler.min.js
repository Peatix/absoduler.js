!function(){function a(){var a;try{a=require("ws")}catch(b){}return a}function b(c){if("undefined"===c)throw"option is not given";if("undefined"===c.server&&"undefined"===c.socket)throw"option server or socket is required";if(this.pongs=[],this.maxPongs=8,this.initialized=!1,this.timerObject=c.timer?c.timer:"undefined"!=typeof window?window:"undefined"!=typeof global?global:null,!this.timerObject)throw"No timer found";if(this.WebSocket=c.WebSocket?c.WebSocket:"undefined"!=typeof WebSocket?WebSocket:a(),!this.WebSocket)throw"No WebSocket found";this.WebSocket.Sender&&(this.isNode=!0),this.serialize=b.Serialize.JSON,this.handlers={},this.timerStock={},c.server?this.isNode?this.connectWebSocketNode(c):this.connectWebSocket(c):this.socket=this._wrapSocket(c.socket),this.startInitialize()}b.prototype._onMessage=function(a){var b=this.serialize.unpack(a);if(!b)throw"Unexpected message";"pong"===b.type&&this.onPong(b),this.scheduleDispatch(b)},b.prototype.connectWebSocketNode=function(a){var c=this;this.socket=new this.WebSocket(a.server),this.socket.on("open",function(){}),this.socket.on("message",function(){b.prototype._onMessage.apply(c,arguments)}),this.socket.on("error",function(a){c.initimer&&(c.timerObject.clearInterval(c.initimer),c.initimer=null),console.error("socket has closed by error: ",a)})},b.prototype.connectWebSocket=function(a){var c=this;this.socket=new this.WebSocket(a.server),this.socket.onopen=function(){},this.socket.onmessage=function(){b.prototype._onMessage.apply(c,arguments)},this.socket.onerror=function(){c.initimer&&(c.timerObject.clearInterval(c.initimer),c.initimer=null),console.error("socket has closed by error")}},b.prototype._wrapSocket=function(a){var b=a.onmessage,c=this;a.onmessage=function(d){var e=c.serialize.unpack(d.data);return e?void("pong"===e.type?c.onPong(e):c.scheduleDispatch(e)):b.call(a,arguments)}},b.prototype._send=function(a){if(1!==this.socket.readyState)throw"cannot send message until connection has created";this.socket.send(this.serialize.pack(a))},b.prototype.ping=function(){var a=(new Date).getTime();this._send({type:"ping",b:a})},b.prototype.onPong=function(a){var b=(new Date).getTime(),c=parseInt(a.b),d=parseInt(a.s),e=(b-c)/2,f=d-c+e,g={b:c,r:e,o:f};if(this.pongs.push(g),this.maxPongs<=this.pongs.length){for(;this.maxPongs<this.pongs.length;)this.pongs.shift();this.initialized||(this.initialized=!0,this.finishInitialize()),this.initialized&&this.calculateOffset()}},b.prototype.calculateOffset=function(){var a,b=36e5,c=this.pongs,d=c.length,e=0,f=0,g=0;for(a=0;d>a;a++)c[a].r<b&&(b=c[a].r);for(a=0;d>a;a++)f=b/c[a].r,e+=c[a].o*f,g+=f;this.offset=e/g},b.prototype.startInitialize=function(){var a=this;this.initimer=this.timerObject.setInterval(function(){if(0===a.socket.readyState)console.log("waiting...");else{if(1!==a.socket.readyState)throw a.timerObject.clearInterval(a.initimer),a.initimer=null,"socket has closed";a.timerObject.clearInterval(a.initimer),a.initimer=null,a._initialize()}},100)},b.prototype._initialize=function(){this.sendPings(this.maxPongs)},b.prototype.sendPings=function(a){for(var b=0,c=this,d=function(){c.ping()};a>b;b++)c.timerObject.setTimeout(d,50*b)},b.prototype.finishInitialize=function(){this.emit("initialized");var a=this;this.updatePingTimer=this.timerObject.setInterval(function(){a.sendPings(a.maxPings/2)},5e3)},b.prototype.scheduleDispatch=function(a){var b=0,c=this;if(a.at){var d=(new Date).getTime();b=parseInt(a.at)-d-this.offset}var e=this.timerObject.setTimeout(function(){c.dispatch(a)},b);this.timerStock[e]=1},b.prototype.dispatch=function(a){this.emit(a.type,a)},b.prototype.clearAllTimer=function(){for(var a in this.timerStock)this.timerObject.clearTimeout(a)},b.prototype.emit=function(a,b){var c=this.handlers[a];if("undefined"!=typeof c)for(var d in c)c[d].call(this,b)},b.prototype.on=function(a,b){var c=this.handlers[a];"undefined"==typeof c&&(this.handlers[a]=c={}),c[b]=b},b.prototype.off=function(a,b){var c=this.handlers[a];"undefined"!=typeof c&&delete c[b]},b.prototype.close=function(){this.ws.close()},"undefined"!=typeof module&&(module.exports=b),"undefined"!=typeof window&&(window.Absoduler=b)}(),function(){var a={JSON:{unpack:function(a){var b;if("string"==typeof a)b=JSON.parse(a);else if("object"==typeof a&&a.data)b=JSON.parse(a.data);else{if("object"!=typeof a)throw console.log("Unrecognizable Message",typeof a,a),"unrecognizable message";b=a}return b},pack:function(a){return JSON.stringify(a)}}};"undefined"!=typeof module&&(module.exports=a),"undefined"!=typeof window&&(window.Absoduler.Serialize=a)}();